#!/bin/bash
#set -e
###############################################################################
# Author	:	Erik Dubois
# Website	:	https://www.erikdubois.be
# Website	:	https://www.arcolinux.info
# Website	:	https://www.arcolinux.com
# Website	:	https://www.arcolinuxd.com
# Website	:	https://www.arcolinuxb.com
# Website	:	https://www.arcolinuxiso.com
# Website	:	https://www.arcolinuxforum.com
###############################################################################
#
#   DO NOT JUST RUN THIS. EXAMINE AND JUDGE. RUN AT YOUR OWN RISK.
#
###############################################################################

result=$(systemd-detect-virt)

echo "You are working on "$result

if [ $result = "oracle" ];
	then
		#remove vmware
		if [ -f /etc/xdg/autostart/vmware-user.desktop ]; then
   			rm /etc/xdg/autostart/vmware-user.desktop
			echo "Removed vmware-user.desktop"
		fi

		if pacman -Qi open-vm-tools &> /dev/null; then
			systemctl disable vmtoolsd.service
			echo "Disabled vmtoolsd.service"
			pacman -Rns open-vm-tools --noconfirm
			echo "Removed open-vm-tools"
			pacman -Rns xf86-video-vmware --noconfirm
			echo "Removed xf86-video-vmware"
		fi

		if [ -f /etc/systemd/system/multi-user.target.wants/vmtoolsd.service ]; then
	   		rm /etc/systemd/system/multi-user.target.wants/vmtoolsd.service
			echo "Removed vmtoolsd.service if still exists"
		fi

		#remove qemu
		if pacman -Qi qemu-guest-agent &> /dev/null; then
			systemctl disable qemu-guest-agent.service
			pacman -Rns qemu-guest-agent --noconfirm
			echo "Removed qemu-guest-agent"
		fi
fi

if [ $result = "kvm" ];
	then
		#remove vmware
		if [ -f /etc/xdg/autostart/vmware-user.desktop ]; then
   			rm /etc/xdg/autostart/vmware-user.desktop
			echo "Removed vmware-user.desktop"
		fi

		if pacman -Qi open-vm-tools &> /dev/null; then
			systemctl disable vmtoolsd.service
			echo "Disabled vmtoolsd.service"
			pacman -Rns open-vm-tools --noconfirm
			echo "Removed open-vm-tools"
			pacman -Rns xf86-video-vmware --noconfirm
			echo "Removed xf86-video-vmware"
		fi

		if [ -f /etc/systemd/system/multi-user.target.wants/vmtoolsd.service ]; then
	   		rm /etc/systemd/system/multi-user.target.wants/vmtoolsd.service
			echo "Removed vmtoolsd.service if still exists"
		fi

		#remove virtualbox
		if pacman -Qi virtualbox-guest-utils &> /dev/null; then
			systemctl disable vboxservice.service
			pacman -Rns virtualbox-guest-utils --noconfirm
			echo "Removed virtualbox-guest-utils"
		fi
		if pacman -Qi virtualbox-guest-utils-nox &> /dev/null; then
			systemctl disable vboxservice.service
			pacman -Rns virtualbox-guest-utils-nox --noconfirm
			echo "Removed virtualbox-guest-utils-nox"
		fi
fi

if [ $result = "vmware" ];
	then
		#remove virtualbox
		if pacman -Qi virtualbox-guest-utils &> /dev/null; then
			systemctl disable vboxservice.service
			pacman -Rns virtualbox-guest-utils --noconfirm
			echo "Removed virtualbox-guest-utils"
		fi
		if pacman -Qi virtualbox-guest-utils-nox &> /dev/null; then
			systemctl disable vboxservice.service
			pacman -Rns virtualbox-guest-utils-nox --noconfirm
			echo "Removed virtualbox-guest-utils-nox"
		fi

		#remove qemu
		if pacman -Qi qemu-guest-agent &> /dev/null; then
			systemctl disable qemu-guest-agent.service
			pacman -Rns qemu-guest-agent --noconfirm
			echo "Removed qemu-guest-agent"
		fi
fi

if [ $result = "none" ];
	then
		#remove virtualbox
		if pacman -Qi virtualbox-guest-utils &> /dev/null; then
			systemctl disable vboxservice.service
			pacman -Rns virtualbox-guest-utils --noconfirm
			echo "Removed virtualbox-guest-utils"
		fi

		if pacman -Qi virtualbox-guest-utils-nox &> /dev/null; then
			systemctl disable vboxservice.service
			pacman -Rns virtualbox-guest-utils-nox --noconfirm
			echo "Removed virtualbox-guest-utils-nox"
		fi

		#remove vmware
		if [ -f /etc/xdg/autostart/vmware-user.desktop ]; then
	   		rm /etc/xdg/autostart/vmware-user.desktop
			echo "Removed vmware-user.desktop"
		fi

		if pacman -Qi open-vm-tools &> /dev/null; then
			systemctl disable vmtoolsd.service
			echo "Disabled vmtoolsd.service"
			pacman -Rns open-vm-tools --noconfirm
			echo "Removed open-vm-tools"
			pacman -Rns xf86-video-vmware --noconfirm
			echo "Removed xf86-video-vmware"
		fi

		if [ -f /etc/systemd/system/multi-user.target.wants/vmtoolsd.service ]; then
	   		rm /etc/systemd/system/multi-user.target.wants/vmtoolsd.service
			echo "Removed vmtoolsd.service if still exists"
		fi

		#remove qemu
		if pacman -Qi qemu-guest-agent &> /dev/null; then
			systemctl disable qemu-guest-agent.service
			pacman -Rns qemu-guest-agent --noconfirm
			echo "Removed qemu-guest-agent"
		fi

	  #systemctl disable virtual-machine-check.service
fi
